<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 交互式粒子宇宙 - 最终版</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        
        /* --- UI 面板 (左上角) --- */
        #ui-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.9);
            background: rgba(0, 15, 30, 0.75);
            backdrop-filter: blur(12px);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #00ffff;
            pointer-events: none; 
            user-select: none;
            width: 280px;
            box-shadow: 0 0 25px rgba(0, 100, 255, 0.15);
            transition: opacity 0.5s;
        }

        h1 { margin: 0 0 8px 0; font-size: 1.4rem; text-transform: uppercase; letter-spacing: 2px; color: #00ffff; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5); }
        p { font-size: 0.9rem; line-height: 1.6; color: #ddd; margin: 4px 0; }
        
        /* 状态指示灯 */
        .status-row { display: flex; align-items: center; margin-bottom: 10px; }
        .status-indicator {
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #555; margin-right: 10px;
            box-shadow: 0 0 5px #000; transition: all 0.3s;
        }
        .status-active { background-color: #00ff00; box-shadow: 0 0 10px #00ff00; }
        
        .scale-display { font-size: 1.8rem; font-weight: bold; color: #ffcc00; text-shadow: 0 0 10px #ffaa00; margin-top: 10px; display: block;}

        /* --- 摄像头预览窗口 (左下角) --- */
        #camera-preview {
            position: absolute;
            bottom: 80px;
            left: 20px;
            width: 200px;
            height: 150px;
            background: #000;
            border: 2px solid #00ffff;
            border-radius: 8px;
            overflow: hidden;
            display: none; 
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            z-index: 10;
        }
        #input-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        /* --- 底部控制按钮 --- */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 15px;
            pointer-events: auto;
            z-index: 20;
        }

        button {
            background: linear-gradient(45deg, rgba(0, 255, 255, 0.1), rgba(0, 100, 255, 0.2));
            border: 1px solid rgba(0, 255, 255, 0.5);
            color: #00ffff;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        button:hover { background: rgba(0, 255, 255, 0.3); box-shadow: 0 0 15px rgba(0, 255, 255, 0.6); transform: translateY(-2px); }

        /* --- 行星名称提示框 (Tooltip) --- */
        #planet-tooltip {
            position: absolute;
            top: 0; left: 0;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid #00ffff;
            color: #fff;
            padding: 8px 15px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none; /* 让鼠标事件穿透 */
            display: none; /* 默认隐藏 */
            z-index: 100;
            box-shadow: 0 0 10px #00ffff;
            backdrop-filter: blur(5px);
            transform: translate(15px, 15px); /* 稍微偏离鼠标位置 */
        }
        #planet-tooltip strong { color: #ffcc00; display: block; font-size: 1.1em; margin-bottom: 2px; }

        /* --- 全屏调整 --- */
        body.is-fullscreen #ui-panel { opacity: 0; pointer-events: none; }
        body.is-fullscreen #camera-preview { display: none !important; }
        #fullscreen-hud {
            position: absolute; top: 20px; right: 20px; text-align: right; display: none; pointer-events: none;
        }
        body.is-fullscreen #fullscreen-hud { display: block; }
        
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #00ffff; font-size: 1.2rem; display: none;
            background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px;
        }
    </style>
</head>
<body>

    <!-- 主 UI 面板 -->
    <div id="ui-panel">
        <h1>Cosmos Core</h1>
        <div class="status-row">
            <span id="cam-status" class="status-indicator"></span>
            <span id="status-text">系统待机 - 点击下方开启</span>
        </div>
        <p>控制台 v3.0</p>
        <p style="font-size: 0.8rem; color: #888;">鼠标悬停查看星体详情</p>
        <span class="scale-display"><span id="scale-val">1.00</span> x</span>
    </div>

    <!-- 鼠标悬浮提示框 -->
    <div id="planet-tooltip">
        <strong id="tt-name">Name</strong>
        <span id="tt-type">Planet</span>
    </div>

    <div id="fullscreen-hud">
        <h2 style="color: #00ffff; margin:0;">SPEED</h2>
        <div id="fs-scale-val" style="color: #ffcc00; font-size: 2rem; font-weight:bold;">1.00x</div>
    </div>

    <div id="camera-preview"><video id="input-video"></video></div>
    <div id="loader">正在初始化视觉模型...</div>

    <div id="controls">
        <button id="btn-camera">启动视觉交互</button>
        <button id="btn-fullscreen">进入沉浸模式</button>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- 全局变量 ---
        let scene, camera, renderer, controls, composer;
        let sun;
        let planets = []; 
        let orbits = [];
        let intersectableObjects = []; // 用于射线检测的对象列表
        
        // 交互变量
        let targetScale = 1.0;
        let currentScale = 1.0;
        let targetSpeed = 1.0;
        let currentSpeed = 1.0;
        let isCameraActive = false;
        let handModel, cameraObj;

        // 射线检测 (Raycaster) 变量
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const tooltip = document.getElementById('planet-tooltip');
        const ttName = document.getElementById('tt-name');
        const ttType = document.getElementById('tt-type');

        // UI 引用
        const uiScale = document.getElementById('scale-val');
        const fsScale = document.getElementById('fs-scale-val');
        const statusText = document.getElementById('status-text');
        const statusIndicator = document.getElementById('cam-status');
        const camPreview = document.getElementById('camera-preview');

        init();

        function init() {
            // 1. 场景
            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.0015);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 3000);
            camera.position.set(0, 40, 90);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.6;

            // 2. 后处理 (Bloom)
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0.15;
            bloomPass.strength = 1.8;
            bloomPass.radius = 0.6;
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // 3. 构建宇宙
            createLighting();
            createSolarSystem();
            createBackgroundStars();
            // 注意：这里删除了 createNebulas() 调用

            // 4. 事件监听
            window.addEventListener('resize', onWindowResize);
            document.getElementById('btn-fullscreen').addEventListener('click', toggleFullscreen);
            document.getElementById('btn-camera').addEventListener('click', startCamera);
            document.addEventListener('fullscreenchange', onFullscreenChange);
            
            // 鼠标移动监听 (用于显示名称)
            window.addEventListener('mousemove', onMouseMove);

            animate();
        }

        // --- 射线检测逻辑 (Tooltip) ---
        function onMouseMove(event) {
            // 将鼠标坐标转换为归一化设备坐标 (-1 到 +1)
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            // 更新 Tooltip 位置跟随鼠标
            if(tooltip.style.display === 'block') {
                tooltip.style.left = event.clientX + 'px';
                tooltip.style.top = event.clientY + 'px';
            }
        }

        function checkIntersections() {
            raycaster.setFromCamera(mouse, camera);
            
            // 检测与行星网格的碰撞
            const intersects = raycaster.intersectObjects(intersectableObjects);

            if (intersects.length > 0) {
                const object = intersects[0].object;
                const name = object.userData.name; // 获取存储的名称
                
                // 显示 Tooltip
                tooltip.style.display = 'block';
                ttName.innerText = name;
                ttType.innerText = name === "Sun" ? "Star" : "Planet";
                
                // 鼠标变为手型
                document.body.style.cursor = 'pointer';
            } else {
                // 隐藏 Tooltip
                tooltip.style.display = 'none';
                document.body.style.cursor = 'default';
            }
        }

        // --- 场景构建 ---

        function createLighting() {
            const sunLight = new THREE.PointLight(0xffaa00, 5, 500);
            scene.add(sunLight);
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6); 
            scene.add(ambientLight);
        }

        function createSolarSystem() {
            // 太阳
            const sunGeo = new THREE.SphereGeometry(6, 64, 64);
            const sunMat = new THREE.MeshBasicMaterial({ color: 0xffdd44 });
            sun = new THREE.Mesh(sunGeo, sunMat);
            
            // 设置太阳的用户数据用于射线检测
            sun.userData = { name: "Sun" };
            intersectableObjects.push(sun);

            const sunGlowMat = new THREE.MeshBasicMaterial({ color: 0xffaa00, transparent: true, opacity: 0.3 });
            const sunGlow = new THREE.Mesh(new THREE.SphereGeometry(7, 32, 32), sunGlowMat);
            sun.add(sunGlow);
            scene.add(sun);

            // 行星配置
            const planetData = [
                { name: 'Mercury', r: 10, s: 0.8, color: 0xA5A5A5, speed: 2.5 },
                { name: 'Venus',   r: 15, s: 1.4, color: 0xFFC649, speed: 2.0 },
                { name: 'Earth',   r: 22, s: 1.5, color: 0x22A6FF, speed: 1.5 },
                { name: 'Mars',    r: 30, s: 1.1, color: 0xFF3333, speed: 1.2 },
                { name: 'Jupiter', r: 45, s: 3.8, color: 0xE0AE6F, speed: 0.8 },
                { name: 'Saturn',  r: 60, s: 3.2, color: 0xF0D080, speed: 0.6, ring: true },
                { name: 'Uranus',  r: 75, s: 2.0, color: 0x4FD0E7, speed: 0.4 },
                { name: 'Neptune', r: 88, s: 1.9, color: 0x3344FF, speed: 0.3 }
            ];

            planetData.forEach(p => {
                // 轨道
                const orbitGeo = new THREE.RingGeometry(p.r - 0.1, p.r + 0.1, 128);
                const orbitMat = new THREE.MeshBasicMaterial({ color: 0xffffff, side: THREE.DoubleSide, transparent: true, opacity: 0.15 });
                const orbit = new THREE.Mesh(orbitGeo, orbitMat);
                orbit.rotation.x = Math.PI / 2;
                scene.add(orbit);
                orbits.push(orbit);

                // 行星本体
                const mat = new THREE.MeshStandardMaterial({
                    color: p.color,
                    roughness: 0.4,
                    metalness: 0.2,
                    emissive: p.color,
                    emissiveIntensity: 0.3
                });
                const mesh = new THREE.Mesh(new THREE.SphereGeometry(p.s, 32, 32), mat);
                
                // 关键：将名称存入 userData，并将 mesh 加入检测列表
                mesh.userData = { name: p.name };
                intersectableObjects.push(mesh);

                const pivot = new THREE.Object3D();
                pivot.add(mesh);
                mesh.position.x = p.r;
                
                if (p.ring) {
                    const ringGeo = new THREE.RingGeometry(p.s * 1.4, p.s * 2.2, 64);
                    const ringMat = new THREE.MeshStandardMaterial({ color: 0xccaacc, side: THREE.DoubleSide, transparent: true, opacity: 0.8, emissive: 0x554455 });
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    ring.rotation.x = Math.PI / 2.5;
                    mesh.add(ring);
                }

                scene.add(pivot);
                planets.push({ mesh, pivot, baseR: p.r, speed: p.speed });
            });
        }

        function createBackgroundStars() {
            const geo = new THREE.BufferGeometry();
            const pos = [];
            const col = [];
            for(let i=0; i<4000; i++) {
                const x = (Math.random() - 0.5) * 900;
                const y = (Math.random() - 0.5) * 500;
                const z = (Math.random() - 0.5) * 900;
                pos.push(x,y,z);
                col.push(1, 1, 1); // 纯白星光，更干净
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(col, 3));
            const mat = new THREE.PointsMaterial({ size: 1.0, vertexColors: true, transparent: true, opacity: 0.9 });
            const stars = new THREE.Points(geo, mat);
            scene.add(stars);
        }

        // --- 核心动画循环 ---
        function animate() {
            requestAnimationFrame(animate);

            // 平滑插值
            currentScale += (targetScale - currentScale) * 0.08;
            currentSpeed += (targetSpeed - currentSpeed) * 0.08;

            // UI 更新
            const displayTxt = currentScale.toFixed(2);
            uiScale.innerText = displayTxt;
            fsScale.innerText = displayTxt + "x";

            // 1. 行星运动
            planets.forEach(p => {
                p.pivot.rotation.y += 0.002 * p.speed * currentSpeed;
                p.mesh.rotation.y += 0.01;
                p.mesh.position.x = p.baseR * currentScale; 
            });

            // 2. 轨道缩放
            orbits.forEach(o => o.scale.setScalar(currentScale));

            // 3. 太阳自转 (移除缩放震动)
            sun.rotation.y += 0.002; 
            // sun.scale.setScalar(...) 已移除

            // 4. 射线检测 (每帧检测)
            checkIntersections();

            if (!isCameraActive) controls.update();

            composer.render();
        }

        // --- 交互逻辑 (手势) ---
        async function startCamera() {
            if (isCameraActive) return;
            const btn = document.getElementById('btn-camera');
            const loader = document.getElementById('loader');
            
            btn.disabled = true;
            loader.style.display = 'block';

            const videoElement = document.getElementById('input-video');

            handModel = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
            handModel.setOptions({
                maxNumHands: 1,
                modelComplexity: 1,
                minDetectionConfidence: 0.6,
                minTrackingConfidence: 0.6
            });

            handModel.onResults(onHandResult);

            cameraObj = new Camera(videoElement, {
                onFrame: async () => { await handModel.send({image: videoElement}); },
                width: 320, height: 240
            });

            try {
                await cameraObj.start();
                isCameraActive = true;
                btn.innerText = "交互运行中";
                statusText.innerText = "识别中: 请对准镜头捏合手指";
                statusText.style.color = "#00ff00";
                statusIndicator.classList.add('status-active');
                if(!document.fullscreenElement) camPreview.style.display = 'block';
                controls.autoRotate = false;
                loader.style.display = 'none';
            } catch (err) {
                console.error(err);
                alert("摄像头启动失败，请检查权限。");
                loader.style.display = 'none';
                btn.disabled = false;
            }
        }

        function onHandResult(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                const p1 = lm[4];
                const p2 = lm[8];
                const dist = Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
                
                let factor = (dist - 0.02) / 0.22; 
                factor = Math.max(0, Math.min(1, factor));
                
                targetScale = 0.5 + factor * 2.5; 
                targetSpeed = 0.2 + factor * 4.0;
                statusIndicator.style.backgroundColor = `hsl(${120 * factor}, 100%, 50%)`; 
            } else {
                targetScale = 1.0;
                targetSpeed = 1.0;
            }
        }

        // --- 辅助功能 ---
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
        function onFullscreenChange() {
            if (document.fullscreenElement) {
                document.body.classList.add('is-fullscreen');
                camPreview.style.display = 'none';
            } else {
                document.body.classList.remove('is-fullscreen');
                if (isCameraActive) camPreview.style.display = 'block';
            }
            onWindowResize();
        }
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }
    </script>
</body>
</html>